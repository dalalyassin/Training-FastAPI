# This file is meant to be included from Nginx's `http {}` context (Debian/Ubuntu loads `/etc/nginx/conf.d/*.conf`). # what this file is / where it must be included
# It sets safe defaults for reverse-proxying FastAPI/Uvicorn plus basic performance/security knobs. # high-level purpose
                                                                                                  # spacer (kept blank-ish intentionally for readability)
server_tokens off; # Hide Nginx version in error pages and the `Server` response header (small security hardening).
                                                                                                  # spacer (kept blank-ish intentionally for readability)
# ---- Rate limiting zones (referenced later with `limit_req zone=...`) ---- # section header
limit_req_zone $binary_remote_addr zone=perip:10m rate=10r/s; # General per-IP limit (10 requests/sec, shared memory zone size 10MB).
limit_req_zone $binary_remote_addr zone=authip:10m rate=2r/s;  # Stricter per-IP limit for auth endpoints (2 requests/sec).
limit_req_zone $binary_remote_addr zone=streamip:10m rate=1r/s; # Strict per-IP limit for streaming/SSE endpoints (1 request/sec).
                                                                                                  # spacer (kept blank-ish intentionally for readability)
# ---- Proxy defaults (good baselines; locations can override) ---- # section header
proxy_http_version 1.1; # Use HTTP/1.1 to the upstream (required for keepalive and helpful for streaming).
proxy_set_header Connection ""; # Enable upstream keepalive by clearing hop-by-hop Connection header.
proxy_buffering on; # Buffer upstream responses by default (better throughput and protects upstream); SSE locations will turn this off.
proxy_busy_buffers_size 64k; # Buffer tuning: how much can be "busy" sending to client before spilling.
proxy_buffers 16 16k; # Buffer tuning: number and size of buffers used for reading responses from upstream.
proxy_buffer_size 16k; # Buffer tuning: initial buffer for reading the first part of the response.
proxy_max_temp_file_size 0; # Avoid writing proxied responses to disk (keeps things fast for typical JSON APIs).
proxy_connect_timeout 5s; # Fail fast if upstream is unreachable.
proxy_send_timeout 60s; # Timeout for sending request to upstream.
proxy_read_timeout 60s; # Timeout for reading response from upstream (SSE locations will increase this).
                                                                                                  # spacer (kept blank-ish intentionally for readability)
# ---- Gzip compression ---- # section header
# NOTE: On Debian/Ubuntu, gzip is typically configured already in `/etc/nginx/nginx.conf`. # why we aren't setting gzip here
# If you want to tune gzip, do it in that file (so you don't get "duplicate directive" errors). # where to tune gzip safely
                                                                                                  # spacer (kept blank-ish intentionally for readability)
# ---- Small timeouts for slow clients (reduce resource usage) ---- # section header
client_header_timeout 10s; # Max time to receive request headers from client.
client_body_timeout 10s; # Max time to receive request body from client.
send_timeout 60s; # Max time to transmit response to the client.
