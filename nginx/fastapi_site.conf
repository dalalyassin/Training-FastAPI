# This file is intended to be symlinked into `/etc/nginx/sites-enabled/` on Debian/Ubuntu. # where this file goes
# It reverse-proxies to a local FastAPI/Uvicorn server running on `127.0.0.1:8000`. # what it does
                                                                                   # spacer (kept blank-ish intentionally for readability)
upstream fastapi_upstream { # Define an upstream pool (even with one server) so we can use keepalive connections.
    server 127.0.0.1:8000; # Your FastAPI server (uvicorn) bind address/port.
    keepalive 32; # Keep up to 32 idle upstream connections per worker for better performance under load.
} # End upstream definition.
                                                                                   # spacer (kept blank-ish intentionally for readability)
server { # Start an HTTP virtual server.
    listen 80; # Listen on IPv4 port 80 (HTTP).
    listen [::]:80; # Listen on IPv6 port 80 (HTTP).
                                                                                   # spacer (kept blank-ish intentionally for readability)
    server_name localhost; # Hostname to match; change to your domain if you have one.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Basic request limits ---- # section header
    client_max_body_size 2m; # Max request body size (your chat JSON is small; keeps abuse in check).
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Security headers (safe defaults; can be tightened later) ---- # section header
    add_header X-Content-Type-Options "nosniff" always; # Prevent MIME type sniffing.
    add_header X-Frame-Options "SAMEORIGIN" always; # Prevent clickjacking (allows same-origin iframes).
    add_header Referrer-Policy "strict-origin-when-cross-origin" always; # Reduce referrer leakage.
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always; # Disable powerful features unless you need them.
    # add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'" always; # OPTIONAL: CSP (may break Swagger UI if too strict).
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Logging tweaks ---- # section header
    access_log /var/log/nginx/fastapi_access.log; # Separate access log for this site (handy when learning).
    error_log  /var/log/nginx/fastapi_error.log warn; # Separate error log for this site.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Health check (fast, quiet) ---- # section header
    location = /health { # Exact match for `/health`.
        access_log off; # Don't log health checks (reduces noise).
        limit_req zone=perip burst=20 nodelay; # Basic per-IP limit with burst for occasional spikes.
        proxy_pass http://fastapi_upstream; # Send request to FastAPI.
        proxy_set_header Host $host; # Preserve original Host header.
        proxy_set_header X-Real-IP $remote_addr; # Pass client IP to app.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Preserve proxy chain.
        proxy_set_header X-Forwarded-Proto $scheme; # Tell app whether original was http/https.
    } # End `/health` location.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Auth endpoints (OAuth redirects + cookies) ---- # section header
    location ^~ /api/auth/ { # Match anything under `/api/auth/` (login/callback/me/logout).
        limit_req zone=authip burst=10 nodelay; # Stricter limit for auth to reduce brute-force/abuse.
        proxy_pass http://fastapi_upstream; # Send request to FastAPI.
        proxy_set_header Host $host; # Preserve original Host header.
        proxy_set_header X-Real-IP $remote_addr; # Pass client IP to app.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Preserve proxy chain.
        proxy_set_header X-Forwarded-Proto $scheme; # Tell app whether original was http/https.
    } # End `/api/auth/` location.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Streaming chat (Server-Sent Events) ---- # section header
    location = /api/chat/stream { # Exact match for SSE endpoint (API-key auth).
        limit_req zone=streamip burst=3 nodelay; # Very strict: streaming endpoints are expensive.
        proxy_pass http://fastapi_upstream; # Send request to FastAPI.
        proxy_set_header Host $host; # Preserve original Host header.
        proxy_set_header X-Real-IP $remote_addr; # Pass client IP to app.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Preserve proxy chain.
        proxy_set_header X-Forwarded-Proto $scheme; # Tell app whether original was http/https.
        proxy_buffering off; # CRITICAL for SSE: don't buffer, stream chunks to the client immediately.
        proxy_cache off; # Don't cache streaming responses.
        gzip off; # Avoid gzip for SSE (can delay flushing and break real-time streaming).
        proxy_read_timeout 1h; # Allow long-lived streams without timing out.
        proxy_send_timeout 1h; # Allow long-lived upstream sends without timing out.
    } # End `/api/chat/stream` location.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    location = /api/chat/stream-test { # Exact match for SSE endpoint (OAuth cookie auth).
        limit_req zone=streamip burst=3 nodelay; # Same strict limit for this streaming endpoint.
        proxy_pass http://fastapi_upstream; # Send request to FastAPI.
        proxy_set_header Host $host; # Preserve original Host header.
        proxy_set_header X-Real-IP $remote_addr; # Pass client IP to app.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Preserve proxy chain.
        proxy_set_header X-Forwarded-Proto $scheme; # Tell app whether original was http/https.
        proxy_buffering off; # CRITICAL for SSE: stream immediately.
        proxy_cache off; # Don't cache streaming responses.
        gzip off; # Avoid gzip for SSE.
        proxy_read_timeout 1h; # Allow long-lived streams.
        proxy_send_timeout 1h; # Allow long-lived streams.
    } # End `/api/chat/stream-test` location.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- Other API endpoints (JSON) ---- # section header
    location ^~ /api/ { # Match remaining API routes like `/api/chat/`.
        limit_req zone=perip burst=50 nodelay; # General API limit with burst.
        proxy_pass http://fastapi_upstream; # Send request to FastAPI.
        proxy_set_header Host $host; # Preserve original Host header.
        proxy_set_header X-Real-IP $remote_addr; # Pass client IP to app.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Preserve proxy chain.
        proxy_set_header X-Forwarded-Proto $scheme; # Tell app whether original was http/https.
    } # End `/api/` location.
                                                                                   # spacer (kept blank-ish intentionally for readability)
    # ---- FastAPI docs + everything else (root, /docs, /redoc, /oauth-test, etc.) ---- # section header
    location / { # Catch-all for `/`, `/docs`, `/redoc`, `/openapi.json`, `/oauth-test`, etc.
        limit_req zone=perip burst=50 nodelay; # General limit for non-stream endpoints.
        proxy_pass http://fastapi_upstream; # Send request to FastAPI.
        proxy_set_header Host $host; # Preserve original Host header.
        proxy_set_header X-Real-IP $remote_addr; # Pass client IP to app.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Preserve proxy chain.
        proxy_set_header X-Forwarded-Proto $scheme; # Tell app whether original was http/https.
    } # End catch-all location.
} # End server block.
