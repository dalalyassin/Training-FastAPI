name: CI

on:
  push:
    branches: ["main", "testing"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd backend
          uv sync --frozen

      - name: Run Ruff (lint)
        run: |
          cd backend
          uv run ruff check .

      - name: Run Ruff (format check)
        run: |
          cd backend
          uv run ruff format --check .

      - name: Run Mypy (types)
        run: |
          cd backend
          uv run mypy . --ignore-missing-imports

      - name: Run Pytest
        run: |
          cd backend
          uv run pytest test/ -v --cov=. --cov-report=xml --cov-report=term

      - name: Validate OpenAPI schema
        run: |
          cd backend
          uv run python -c "
          import json
          import sys
          from main import app

          schema = app.openapi()

          required_fields = ['openapi', 'info', 'paths']
          missing_fields = [field for field in required_fields if field not in schema]

          if missing_fields:
              print(f'ERROR: Missing required OpenAPI fields: {missing_fields}')
              sys.exit(1)

          if not schema.get('openapi', '').startswith('3.'):
              print(f'ERROR: Invalid OpenAPI version: {schema.get(\"openapi\")}')
              sys.exit(1)

          if not schema.get('paths'):
              print('ERROR: No paths defined in OpenAPI schema')
              sys.exit(1)

          print('✓ OpenAPI schema is valid')
          print(f'✓ OpenAPI version: {schema.get(\"openapi\")}')
          print(f'✓ API title: {schema.get(\"info\", {}).get(\"title\")}')
          print(f'✓ Number of paths: {len(schema.get(\"paths\", {}))}')
          "
